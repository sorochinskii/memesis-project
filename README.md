# memesis project

### Предисловие.
Для удобства все env файлы специально загружены в GitHub и volumes в docker-compose не используются.

### Версии
Docker version 20.10.22
Docker Compose version v2.24.4
Python 3.10 для тестирования и локального запуска.
Python 3.11 в контейнерах.
Остальное в файлах requirements.txt
  
### Технологии
Основной стек FastAPI, SQLAlchemy, PostgresSQL, boto3 как клиент для MiniO, httpx.
Миграции Alembic
Тестирование pytest, testcontainers (postgres).
Управление настройками pydantic-settings.
Логирование Loguru.

### Описание

Публичное API предназначено для

- создания мема; Каждый мем это название, текст и картинка.

- картинки при создании проходят валидацию на размер и разрешение

- название, текст и идентификатор мема хранятся в реляционной БД

- обновления мема - сохраняется идентификатор, но меняется вся остальная информация о меме

- удаления мема - в базе данных мем помечается удаленным, на приватный сервер отправляется запрос на удаление картинки.  

Приватное API предназначено для взаимодействия с s3

- загрузка файла в s3-хранилище

- скачивание файла из s3-хранилища

- замена файла в хранилище с сохранением идентификатора

- удаление файла из хранилища.


### Описание хранения и получения мемов
В базе данных хранятся имя мема, текст, расширение картинки, идентификатор - primary key типа UUID4. В s3-хранилище ключ файла - UUID4-идентификатор из базы данных.

Скачивание картинки происходит по алгоритму 
- бэкенд публичной части запрашивает presigned ссылку из приватной части, 
- формирует jwt-токен с нагрузкой этой ссылки 
- и возвращает клиенту ответ со ссылкой на публичный сервер с этим токеном в виде параметра пути (также в ответе присутствует токен отдельно для удобства).

### Запуск тестов
Создать виртуальное окружение. Активировать его.
Необходимо перейти относительно корня проекта, установить зависимости, запустить тесты
```BASH
cd source/public_api
pip install -r requirements.txt
pytest
```
   
### Как запустить проект.
После обоих нижеописанных способах запуска
SwaggerUI будет доступен 
 - для публичной части http://localhost:8001/v1/docs 
 - для приватной части http://localhost:8002/v1/docs

1. ***Запуск в контейнерах***

Перейти в корень директории проекта.
```BASH
docker compose build
docker compose up
```
2. ***Запуск смешанный***
В этом случае запускаются контейнеры базы данных и s3-хранилища, а бэкенды публичной и приватной части запускаются вручную.
Сначала запустить контейнеры из корня проекта
```BASH
docker compose up mc db
```
Если запуск контейнеров произошел без проблем, двигаемся далее. 
Если не создано окружение (например, то же окружение, что и в части тестирования), создать его, активировать. Установить зависимости
```BASH
pip install -r source/public_api/requirements.txt
pip install -r source/private_api/requirements.txt
```
**Замечание.** *Важно установить переменную окружения ENVIRONMENT в значение local перед запуском любого из бэкендов проекта.*
*Например, в консоли написать*
```BASH
export ENVIRONMENT=local
```
*Но при таком способе переменная окружения экспортируется только в текущий сеанс консоли. Будьте внимательны, от этой переменной зависит правильный запуск приложений в этом проекте.*

Затем запустить публичную часть 
```BASH
cd source/public_api/
python main.py
```
Запустить другой сеанс консоли, экспортировать переменную окружения ENVIRONMENT (как описано выше), активировать окружение. Затем относительно корня проекта
```BASH
cd source/private_api/
python main.py
```

### Последовательность использования
Открываем  http://localhost:8001/v1/docs 
1. POST[/memes](http://localhost:8001/v1/docs#/memes/upload_memes_post)
Загружаем картинку с именем и описанием. В ответе присутсвует id картинки. Копируем его.
2. GET[/memes/{id}](http://localhost:8001/v1/docs#/memes/get_by_id_memes__id__get)
Получаем мем - имя, текст, картинка ссылкой с токеном.
Можно скопировать либо токен, либо сразу ссылку.
3. GET[/memes/get_image/{token}](http://localhost:8001/v1/docs#/memes/get_image_by_token_memes_get_image__token__get)
Получение картинки по токену.
4. PUT[/memes/{id}](http://localhost:8001/v1/docs#/memes/replace_meme_memes__id__put)
Обновление мема.
5. DELETE[/memes/{id}](http://localhost:8001/v1/docs#/memes/delete_meme_memes__id__delete)
Мем в базе данных помечается удаленным, картинка в хранилище удаляется.
6. GET[/memes](http://localhost:8001/v1/docs#/memes/list_memes_memes_get)
Список мемов с пагинацией.
